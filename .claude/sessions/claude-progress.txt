# Clara Voice Agent - Session Progress

## Architecture: Voice Agent Options

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CLARA VOICE AGENT                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  OPTION 1: ElevenLabs Voice Agents (PRIMARY - RECOMMENDED)          │
│  ─────────────────────────────────────────────────────────          │
│  • Better pricing and modularity                                     │
│  • Production-ready in master/develop branches                       │
│  • Hook: useElevenLabsAgent.ts                                       │
│  • Audio: 16kHz → resample → 24kHz for HeyGen                        │
│                                                                      │
│  OPTION 2: OpenAI Realtime (ALTERNATIVE)                            │
│  ─────────────────────────────────────────                          │
│  • Branch: claude/integrate-openai-voice-agent-h7m2K                │
│  • Hook: useOpenAIRealtimeAgent.ts                                   │
│  • Audio: 24kHz direct to HeyGen (no resample needed)               │
│  • Uses "Chunking Agrupado" strategy (8 chunks ≈ 80KB)              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Session: 2025-12-24 (Part 2) - Audio First Words Cut Off Fix

### Problem Solved
**Primeras palabras del audio cortadas** - El agente respondía pero las primeras palabras no se escuchaban (aunque aparecían en logs).

### Root Cause
ElevenLabs envía múltiples `user_transcript` events (streaming transcription). Transcripts tardíos llegaban DESPUÉS de que chunks de audio ya estaban en buffer, y el código los borraba.

### Solution
Mover limpieza de buffer de `onUserTranscript` a `onInterruption`:
- `onUserTranscript`: Solo interrumpe HeyGen avatar (no borra buffer)
- `onInterruption`: Borra buffer (ElevenLabs confirmó interrupción real)

### Files Modified
- `apps/demo/src/components/ClaraVoiceAgent.tsx`
  - `onInterruption` (563-578): Añadida lógica de limpieza de buffer
  - `onUserTranscript` (579-600): Removida limpieza de buffer

### Commit
```
8921ad6 fix: prevent late user_transcript from clearing audio buffer
```

---

## Session: 2025-12-24 - OpenAI Realtime Integration (ALTERNATIVE)

### Summary
Implemented OpenAI Realtime API as an **ALTERNATIVE** to ElevenLabs Voice Agents.
- ElevenLabs remains PRIMARY (better pricing, modularity)
- OpenAI Realtime available in separate branch for different use cases

### Problem Solved (in OpenAI branch)
**Audio Choppy/Cortado** - Fixed with "Chunking Agrupado" strategy:
```typescript
const CHUNK_GROUP_SIZE = 8;  // ~80KB groups
const CHUNK_GAP_THRESHOLD = 500;  // Fallback flush
```

### Branch for OpenAI Alternative
`claude/integrate-openai-voice-agent-h7m2K`

### Files in OpenAI Branch (not in develop/master)
- `apps/demo/src/hooks/useOpenAIRealtimeAgent.ts`
- `apps/demo/app/api/openai-realtime/route.ts`
- Modified `ClaraVoiceAgent.tsx` to use OpenAI hook

### Key Learnings
1. **WebSocket es necesario** (no WebRTC) para interceptar audio para HeyGen
2. **HeyGen acepta PCM16 24kHz base64** - divide internamente en 20ms chunks
3. **El tamaño de chunk importa** - muy pequeño = choppy, muy grande = latencia

---

## Session: 2025-12-21

### Completed
- [x] Session limit feature (10 min max, 30s warning)
- [x] Vercel PR preview workflow configured
- [x] PR #1 merged to master
- [x] Production deploy successful

### Key Decisions
- Vercel preview: Use PR workflow instead of dedicated develop branch
- Framework settings: Keep Root Directory = apps/demo, Framework = Next.js
- Session limit: Enabled by default, 10 minutes, configurable via constants

### Technical Fixes
- Fixed React setState error (calling onEndCall inside state setter)
- Separated timer logic into two useEffects to avoid render-phase updates

### Files Modified
- apps/demo/src/components/ClaraVoiceAgent.tsx (session limit feature)
- .github/BRANCH_STRATEGY.md (documentation)
- CLAUDE.md (updated with workflow)

### Production URLs
- Production: https://clara-beauty.vercel.app
- Preview: Via PR to master (auto-generated)

---

## Bugs Identified (Pending)

| ID | Description | Priority | Status |
|----|-------------|----------|--------|
| #2 | Memory leak - event listeners not cleaned | Medium | Pending |
| #3 | Race condition in audio buffer | Medium | Pending |
| #4 | No HeyGen reconnection on disconnect | Low | Pending |
| #5 | Silent failure on mic permission denied | Medium | Pending |

---

## Next Session Recommendations
1. Fix bug #2 (memory leak) - most impactful
2. Fix bug #5 (mic permission UX)
3. Consider adding session analytics/logging
